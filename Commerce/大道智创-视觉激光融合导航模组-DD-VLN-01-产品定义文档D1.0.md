[TOC]

# 1. 版本信息

## 1.1 产品版本信息

| 产品名称             | 产品编号  |
| -------------------- | --------- |
| 视觉激光融合导航模组 | DD-VLN-01 |

## 1.2 文档版本记录

| **版本号** | **修订时间** | **修订人** | **修订类型** | **修订章节** | **修订内容** |
| ---------- | ------------ | ---------- | ------------ | ------------ | ------------ |
| 1.0        | 2019-04-17   | 邢志伟     | 创建         | 全部         |              |
|            |              |            |              |              |              |

修订类型分为**A** - ADDED **M** - MODIFIED **D** – DELETED

# 2. 文档说明

## 2.1 文档简介

本文档主要描述视觉激光整合导航模组DD-VLN-01的功能需求点及其设计，目的在于清晰地定义产品整体功能与架构，以及各模块的需求细节。

## 2.2 文档读者

本文档主要面向以下读者：视觉激光整合导航模组DD-VLN-01产品的产品经理、项目经理、研发人员、测试人员、市场运营人员、管理人员等。

# 3. 产品简介

视觉激光融合导航模组为自主移动机器人的自主定位与导航规划模组，它以视觉摄像头和单线激光雷达为主要传感器，以PC工控机平台为计算平台，接受上层应用输入的导航任务，输出控制指令使机器人在室内环境自主执行任务，支持差分运动结构的控制。

本模组定义适用于室内平面场景。

# 4. 产品架构

## 4.1 硬件架构

## 4.2 软件架构

### 4.2.1 融合SLAM核心算法库
整个系统的计算核心，保证导航功能运行的计算功能。以动态库的形式，开放公有接口，供逻辑层调用


### 4.2.2 通讯Wrapper模块

通讯Wrapper模块需要将5.2.5节所有SLAM核心模块的接口在不同的通讯协议下，均提供包装实现。

通讯协议当前采用TCP/IP协议Protobuf数据传输的方式，和外部控制端Client通讯。

通讯协议也支持HTTP服务器的方式，响应上层应用发来的POST与GET请求。5.2.5节中，设置、配置、控制等接口采用POST请求，获取接口采用GET请求。

以源码形式，供逻辑层调用

### 4.2.3  硬件管理模块

封装直接操作硬件的指令,开放公有接口，供逻辑层调用

### 4.2.4 任务逻辑模块

处理所有任务逻辑，（除计算核心算法和硬件直接操作外的所有工作，都是任务逻辑）。调用核心算法库，硬件管理库，通讯模块代码

### 4.2.5 客户端C++ SDK
C++语言的通讯SDK，供二次开发使用。SDK负责与通讯模块以TCP的方式通讯，以动态库的形式，供有二次开发能力的客户调用

### 4.2.6 客户端JAVA ANDROID SDK
JAVA语言的通讯SDK，运行在ANDROID操作系统上，供二次开发使用。SDK负责与通讯模块以TCP的方式通讯，以JAR包的形式，供有二次开发能力的客户调用。




# 5. 详细功能说明

## 5.1 整体功能说明

### 5.1.1 开机

打开工控机电源后，模组软件系统可以自动运行，检测、配置视觉、激光雷达传感器的工作状态，与运动控制器建立通讯，并等待上层应用通过网络进行连接、配置与控制。

### 5.1.2 建图

对新场景，首先需要通过5.3.1节中描述的建图配置程序进行地图构建工作，生成环境地图。

地图为平面栅格地图，同时，也会保存路径中相应参考点位置所采集的摄像头图片，用于视觉重定位。以构建地图时的出发点作为坐标系原点，机器人正前方为X轴正方向，左手方向为Y轴正方向，旋转轴正方向垂直地面向上。

采集过程中，操作者通过建图配置程序控制机器人在环境中行走，行走结束后，自动生成地图文件及保存受控行走的路径文件。

对于已采集的所有地图，可以查看当前地图列表，并选择某个地图为工作地图或进行相应的编辑工作。对地图的编辑主要有以下几种：修改地图名称；删除地图中某区域内的点；虚拟墙管理，包括获取虚拟墙列表，增加虚拟墙，删除某虚拟墙。

对于当前地图内的路径，可以查看所有路径列表，也可以点选一系列点新建路径，还可以选择某路径文件并对路径进行编辑（增、删路径点）。路径点和路径边可以配置不同属性，详见5.2.4节中的说明。

### 5.1.3 工作

自主工作前，需要选择当前环境地图，并且配置工作模式。指定路径模式需指定工作路径；A-B重复模式需选定A-B点，指定点模式需选择指定点。

机器人按照指定的工作模式在地图中执行自主行走任务。初始化过程尝试进行全局重定位，为了提高成功率也可以用户指定当前的大致位置，初始化失败告警，成功则开始执行任务。机器人行走过程中，上报类型接口将持续上报机器人当前执行任务状态与定位状态，如出现丢失，上位机应用也可以随时控制进行全局重定位或指定区域重定位操作。

执行自主行走任务过程中，上位机可以随时查询机器人当前运动状态，任务顺利执行结束后进入待命状态。

### 5.1.4 关机

上位机可通过指令控制工控机完全关闭。

## 5.2 SDK接口需求

### 5.2.1 激光雷达驱动

| 接口                 | 定义                                             |
| -------------------- | ------------------------------------------------ |
| 获取激光雷达工作状态 | 返回当前激光雷达的工作状态，错误状态下返回错误码 |
| 获取原始点云         | 返回激光雷达当前帧的原始点云数据                 |
| 配置激光雷达参数     | 配置激光雷达相关参数，如扫描频率等               |

### 5.2.2 相机驱动

| 接口             | 定义                                         |
| ---------------- | -------------------------------------------- |
| 获取相机工作状态 | 返回当前相机的工作状态，错误状态下返回错误码 |
| 获取原始图像     | 返回当前帧的原始图像                         |
| 配置相机参数     | 配置相机的参数，如曝光时间、增益等           |

### 5.2.3 运动控制驱动

| 接口     | 定义                                                         |
| ---------------- | -------------------------------------------- |
| 获取运动状态 | 获取当前运动状态，包括当前机器人速度、角速度、时间戳。 |
| 设置运动速度 | 设置当前线速度、角速度 |
| 设置电机转速 | 设置差分运动结构的左、右电机转速 |
| 配置底盘结构参数 | 配置底盘结构尺寸参数等 |

说明：

获取运动状态接口中，速度、角速度由电机编码器、IMU数据，结合底盘结构参数计算得到

### 5.2.4  SLAM核心模块

| 接口           | 定义                                                         |
| -------------- | ------------------------------------------------------------ |
| 开始构建地图   | 从空闲状态，进入地图构建状态                                 |
| 暂停构建地图   | 暂停地图构建过程，进入暂停子状态                             |
| 继续构建地图   | 从暂停子状态恢复，继续地图构建过程                           |
| 结束构建地图   | 结束地图构建状态，返回地图构建结果。同时，异常状态下返回异常码，正常状态下返回地图名 |
| 修改地图名称   | 修改指定地图的名称                                           |
| 删除地图点     | 删除指定地图中选定多边形区域内的点。                         |
| 获取虚拟墙列表 | 获取指定地图中的虚拟墙列表                                   |
| 增加虚拟墙     | 在指定地图中增加一道虚拟墙                                   |
| 删除虚拟墙     | 删除指定地图中的指定虚拟墙                                   |
| 获取地图列表   | 返回当前保存的所有构建过的地图名列表                         |
| 获取地图       | 按照指定格式，返回指定的地图。格式（如图片或点云）与地图名由输入参数确定 |
| 删除地图       | 删除指定的地图，及地图相关的路径、虚拟墙等所有文件           |
| 选择工作地图   | 选择当前所使用的地图                                         |
| 设置工作模式   | 配置当前工作模式，可以是指定路径模式，A-B重复模式，抵达指定点模式，人工操控模式 |
| 获取路径列表   | 获取某地图下的工作路径列表                                   |
| 获取路径       | 获取指定地图中的指定路径文件                                 |
| 新建路径       | 在指定地图中新建路径文件                                     |
| 修改路径       | 修改指定地图中的某路径文件                                   |
| 设置工作路径   | 设置自动工作模式所使用的行走工作路径                         |
| 设置循环AB点   | 设置A-B重复模式下的A、B点坐标                                |
| 设置指定目标点 | 设置抵达指定点工作模式下的指定目标点                         |
| 设置路径点参数 | 设置路径点类型参数或其他参数                                 |
| 设置路径边参数 | 设置路径边类型参数或其他参数                                 |
| 全地图初始化   | 在全局地图范围内，寻找自身位置                               |
| 设定当前位置   | 设置机器人当前在地图中的大致位置（重定位）                   |
| 进入自动状态   | 进入自动工作状态，使用当前所选择的地图与工作模式             |
| 获取运动状态   | 返回当前运动状态，包括机器人的平面位置、姿态，当前线速度、角速度 |
| 设置最大速度   | 设置最大线速度与角速度                                       |
| 设置行走速度   | 设置行走线速度                                               |
| 设置最大加速度 | 设置最大线加速度与角加速度                                   |
| 人工操控       | 在人工操控模式下，执行指定的线速度与角速度                   |
| 关机           | 关闭工控机                                                   |
| 上报任务状态   | 主动上报工作信息，执行中，到达目标点，无法到达目标点         |
| 上报运动状态   | 主动上报定位状态，丢失，定位成功                             |
| 上报抵达目标点 | 主动上报已抵达某目标点                                       |

说明：

设置路径点参数接口中，可设置的路径点类型包括：经过点（路径中需经过，但不必必须到达此点）；必达点（比较重要的路径点，必须抵达此点）；动作点（及其相应动作配置，到达后需执行不同的动作，如转向150度，前进1M，后退1M等）；上报目标点（抵达此点后须主动上报）

设置路径边参数接口中，可设置的路径边类型包括：避障模式（静态避障或动态避障）；不使用平面激光匹配（如坡道等区域，不适合使用平面激光雷达用来匹配定位）。其他参数包括：最大允许速度；默认速度；

## 5.3 操作流程图

### 5.3.1 建图配置流程图

### 5.3.2 Demo操作流程图   

## 5.4 规格表

| 参数         | 规格     |
| ------------ | -------- |
| 工作温度     | 0-40度   |
| 雷达探测距离 | <25米    |
| 雷达工作角度 | 270度    |
| 相机分辨率   |          |
| 相机FOV      |          |
| 定位精度     | +-5cm    |
| 定位更新频率 | 20Hz     |
| 适用环境     | 室内     |
| 适用场景面积 | 平方米   |
| 工控机规格   | 12V2A    |
| 交换机规格   | 12V500mA |

# 6 其他需求

无

# 7 产品规划

## 7.1 人员需求

算法工程师：1-2人

软件工程师：2人

结构工程师：1人

硬件工程师：1人

测试工程师：1-2人

主要工作负担，在于算法工程师的核心SDK算法开发调试，软件工程师的通讯Wrapper模块开发调试以及建图程序和Demo程序的开发调试，测试工程师的测试。结构工程师与硬件工程师的工作负担较小。

## 7.2 进度规划

## 7.3 测试计划

### 7.3.1 BringUp

### 7.3.2 功能操作测试

### 7.3.3 性能指标测试

# 8 附录

## 8.1 产品清单

### 8.1.1 硬件模块列表

| 名称          | 型号         | 数量 | 其他 |
| ------------- | ------------ | ---- | ---- |
| 工控机        | I5, 4G RAM   | 1    | Win  |
| 相机          | 华睿 XXX     | 1    | Win  |
| 镜头          | Computar 5mm | 1    |      |
| 激光雷达      | Akusense XXX | 1    | Win  |
| 千兆交换机    |              | 1    |      |
| USB转串口模块 |              | 1    |      |

### 8.1.2 其他

结构件、连接线、包装盒、说明书、合格证

SDK开发包，相应的接口说明文档，Demo程序及源码，建图程序

视觉标定程序及标定使用的标准棋盘格图片，同时需提供视觉与激光相对位姿标定所需使用的标定程序及使用说明。

## 8.2 输出文档

### 8.2.1 生成文档

BOM清单

相关源文件，包括但不限于硬件原理图、PCB源文件及Gerber文件、软件源代码，结构图纸，包装图纸等

### 8.2.2 测试文档

测试验收报告

生产测试用例及测试流程操作规范

常见故障维修指引